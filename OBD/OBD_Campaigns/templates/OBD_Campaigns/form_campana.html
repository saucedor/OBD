{% extends 'OBD/layouts/blank.html' %}

{% block layout %}

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-8">
    <div class="max-w-4xl mx-auto px-6">
        
        <!-- Mostrar mensajes de Django -->
        {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl flex items-center gap-2 mb-4">
                        <i class="fas fa-check-circle"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl shadow-lg mb-4">
                <i class="fas fa-bullhorn text-white text-2xl"></i>
            </div>
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Crear Nueva Campaña</h1>
            <p class="text-gray-600 text-lg">Completa la información para crear una campaña publicitaria</p>
        </div>

        <!-- Formulario -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
            <form method="POST" enctype="multipart/form-data" id="campana-form" autocomplete="off">
                {% csrf_token %}
                
                <!-- Progress Bar -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 h-1"></div>
                
                <div class="p-8">
                    <!-- Información Básica -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                            <i class="fas fa-info-circle text-blue-600"></i>
                            Información Básica
                        </h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Nombre de la Campaña -->
                            <div class="space-y-2">
                                <label for="{{ form.nombre_campana.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-tag text-blue-500 mr-2"></i>{{ form.nombre_campana.label }}
                                </label>
                                {{ form.nombre_campana }}
                                {% if form.nombre_campana.help_text %}
                                    <p class="text-xs text-gray-500">{{ form.nombre_campana.help_text }}</p>
                                {% endif %}
                                {% if form.nombre_campana.errors %}
                                    <div class="text-red-500 text-sm flex items-center gap-1">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ form.nombre_campana.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Nombre de la Empresa -->
                            <div class="space-y-2">
                                <label for="{{ form.nombre_empresa.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-building text-green-500 mr-2"></i>{{ form.nombre_empresa.label }}
                                </label>
                                {{ form.nombre_empresa }}
                                {% if form.nombre_empresa.help_text %}
                                    <p class="text-xs text-gray-500">{{ form.nombre_empresa.help_text }}</p>
                                {% endif %}
                                {% if form.nombre_empresa.errors %}
                                    <div class="text-red-500 text-sm flex items-center gap-1">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ form.nombre_empresa.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Contacto del Dueño -->
                            <div class="space-y-2">
                                <label for="{{ form.contacto_dueno.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-user text-purple-500 mr-2"></i>{{ form.contacto_dueno.label }}
                                </label>
                                {{ form.contacto_dueno }}
                                {% if form.contacto_dueno.help_text %}
                                    <p class="text-xs text-gray-500">{{ form.contacto_dueno.help_text }}</p>
                                {% endif %}
                                {% if form.contacto_dueno.errors %}
                                    <div class="text-red-500 text-sm flex items-center gap-1">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ form.contacto_dueno.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Estado -->
                            <div class="space-y-2">
                                <label for="{{ form.estado.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-toggle-on text-orange-500 mr-2"></i>{{ form.estado.label }}
                                </label>
                                {{ form.estado }}
                                {% if form.estado.help_text %}
                                    <p class="text-xs text-gray-500">{{ form.estado.help_text }}</p>
                                {% endif %}
                                {% if form.estado.errors %}
                                    <div class="text-red-500 text-sm flex items-center gap-1">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ form.estado.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Descripción -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                            <i class="fas fa-edit text-blue-600"></i>
                            Descripción de la Campaña
                        </h2>
                        
                        <div class="space-y-2">
                            <label for="{{ form.descripcion_campana.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-align-left text-indigo-500 mr-2"></i>{{ form.descripcion_campana.label }}
                            </label>
                            {{ form.descripcion_campana }}
                            {% if form.descripcion_campana.help_text %}
                                <p class="text-xs text-gray-500">{{ form.descripcion_campana.help_text }}</p>
                            {% endif %}
                            {% if form.descripcion_campana.errors %}
                                <div class="text-red-500 text-sm flex items-center gap-1">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    {{ form.descripcion_campana.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Imagen -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                            <i class="fas fa-image text-blue-600"></i>
                            Imagen de la Campaña
                        </h2>
                        
                        <div class="space-y-2">
                            <label for="{{ form.foto.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-camera text-pink-500 mr-2"></i>{{ form.foto.label }}
                            </label>
                            
                            <!-- Drop zone personalizada -->
                            <div class="relative">
                                <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-500 transition-colors duration-200 bg-gray-50 hover:bg-blue-50">
                                    <div id="drop-zone-content">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                        <p class="text-gray-600 mb-2">Arrastra una imagen aquí o</p>
                                        <button type="button" id="select-file-btn" class="text-blue-600 hover:text-blue-700 font-semibold">selecciona un archivo</button>
                                    </div>
                                    <div id="file-preview" class="hidden">
                                        <img id="preview-image" class="max-w-xs max-h-48 mx-auto rounded-lg shadow-lg" alt="Preview">
                                        <p id="file-name" class="text-sm text-gray-600 mt-2"></p>
                                    </div>
                                </div>
                                {{ form.foto }}
                            </div>
                            
                            {% if form.foto.help_text %}
                                <p class="text-xs text-gray-500">{{ form.foto.help_text }}</p>
                            {% endif %}
                            {% if form.foto.errors %}
                                <div class="text-red-500 text-sm flex items-center gap-1">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    {{ form.foto.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Asignaciones -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                            <i class="fas fa-users text-blue-600"></i>
                            Asignaciones
                        </h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Cliente -->
                            <div class="space-y-2">
                                <label for="{{ form.cliente.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-user-tie text-green-500 mr-2"></i>{{ form.cliente.label }}
                                </label>
                                {{ form.cliente }}
                                {% if form.cliente.help_text %}
                                    <p class="text-xs text-gray-500">{{ form.cliente.help_text }}</p>
                                {% endif %}
                                {% if form.cliente.errors %}
                                    <div class="text-red-500 text-sm flex items-center gap-1">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ form.cliente.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Staff/Vendedores -->
                            <div class="space-y-2">
                                <label for="{{ form.vendedores.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-user-friends text-blue-500 mr-2"></i>{{ form.vendedores.label }}
                                </label>
                                {{ form.vendedores }}
                                {% if form.vendedores.help_text %}
                                    <p class="text-xs text-gray-500">{{ form.vendedores.help_text }}</p>
                                {% endif %}
                                {% if form.vendedores.errors %}
                                    <div class="text-red-500 text-sm flex items-center gap-1">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ form.vendedores.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="flex flex-col sm:flex-row gap-4 justify-end pt-6 border-t border-gray-200">
                        <button type="button" id="cancelar-btn" class="px-8 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-all duration-200 flex items-center justify-center gap-2">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                        <button type="submit" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                            <i class="fas fa-save"></i>
                            Crear Campaña
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript mejorado para prevenir cache y limpiar formulario -->
<script>
    // CRÍTICO: Prevenir que el navegador cache esta página
    if (window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
    }

    // Limpiar formulario al cargar desde cache
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
            // Página cargada desde cache o botón "atrás"
            document.getElementById('campana-form').reset();
            
            // Limpiar preview de imagen
            const dropZoneContent = document.getElementById('drop-zone-content');
            const filePreview = document.getElementById('file-preview');
            if (dropZoneContent && filePreview) {
                dropZoneContent.classList.remove('hidden');
                filePreview.classList.add('hidden');
            }
        }
    });

    // Limpiar formulario antes de salir de la página
    window.addEventListener('beforeunload', function() {
        const form = document.getElementById('campana-form');
        if (form) {
            form.reset();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Manejo del input de archivo con drag & drop
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('{{ form.foto.id_for_label }}');
        const selectFileBtn = document.getElementById('select-file-btn');
        const dropZoneContent = document.getElementById('drop-zone-content');
        const filePreview = document.getElementById('file-preview');
        const previewImage = document.getElementById('preview-image');
        const fileName = document.getElementById('file-name');

        // Ocultar input original
        if (fileInput) {
            fileInput.style.display = 'none';
        }

        // Click en "seleccionar archivo"
        if (selectFileBtn && fileInput) {
            selectFileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                fileInput.click();
            });
        }

        // Cambio en input de archivo
        if (fileInput) {
            fileInput.addEventListener('change', handleFileSelect);
        }

        // Drag & Drop
        if (dropZone) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && fileInput) {
                    fileInput.files = files;
                    handleFileSelect();
                }
            });
        }

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (previewImage && fileName && dropZoneContent && filePreview) {
                            previewImage.src = e.target.result;
                            fileName.textContent = file.name;
                            dropZoneContent.classList.add('hidden');
                            filePreview.classList.remove('hidden');
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('Por favor selecciona un archivo de imagen válido.');
                    fileInput.value = '';
                }
            }
        }

        // Botón cancelar
        const cancelarBtn = document.getElementById('cancelar-btn');
        if (cancelarBtn) {
            cancelarBtn.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que quieres cancelar? Se perderán todos los cambios.')) {
                    window.location.href = '{% url "vista_campanas" %}';
                }
            });
        }
    });
</script>

<style>
    /* Estilos adicionales para el formulario */
    .form-field {
        transition: all 0.2s ease;
    }
    
    .form-field:focus {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    /* Animación para los errores */
    .text-red-500 {
        animation: shake 0.3s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-2px); }
        75% { transform: translateX(2px); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .grid-cols-1.lg\\:grid-cols-2 {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}